FROM debian:stretch-slim

# Configure environment variables and working directory.
ENV DIRPATH /root
WORKDIR ${DIRPATH}

# Copy LibSSH and vulnerability patches.
COPY libssh-0.8.3.tar.xz ${DIRPATH}
COPY cve-2018-10933.patch ${DIRPATH}
COPY server.patch ${DIRPATH}

# Install essentials.
RUN apt-get update
RUN apt-get install --no-install-recommends -y \
    xz-utils \
    make \
    gcc \
    cmake \
    build-essential \
    ssh \
    zlib1g-dev \
    libssl-dev

# Build, install and patch vulnerable LibSSH.
RUN tar xf libssh-0.8.3.tar.xz && \
    mv libssh-0.8.3 .libssh-0.8.3 && \
    cd .libssh-0.8.3 && \
    patch -p0 < ${DIRPATH}/cve-2018-10933.patch && \
    patch -p0 < ${DIRPATH}/server.patch && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make && \
    make install && \
    cd examples && \
    make && \
    cp ssh_server_fork ${DIRPATH}/libssh && \
    ssh-keygen -t dsa -f ${DIRPATH}/.ssh/libssh_dsa -N '' && \
    ssh-keygen -t rsa -b 2048 -f ${DIRPATH}/.ssh/libssh_rsa -N ''

# Clean up files
RUN rm libssh-0.8.3.tar.xz && \
    rm *patch

# Clean up packages.
RUN apt-get purge -y \
    xz-utils \
    make \
    gcc \
    cmake \
    build-essential \
    ssh \
    zlib1g-dev \
    libssl-dev

CMD ["./libssh", "-d", "./.ssh/libssh_dsa", "-k", "./.ssh/libssh_rsa", "-p", "22", "-v", "0.0.0.0"]